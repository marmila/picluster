---

- name: Deploy Kubernetes resources via master node.
  hosts: k3s_master
  gather_facts: false

  collections:
    - kubernetes.core

  environment:
    # The location of the kubeconfig file on the master.
    K8S_AUTH_KUBECONFIG: ~/.kube/config

  pre_tasks:
    # Install kubernetes core collection dependencies (kubernetes python package) using PIP.
    - name: Ensure PIP is installed.
      package:
        name:
          - python3-pip
          - python3-setuptools
        state: present
      become: true

    - name: Ensure kubernetes Python library is installed.
      pip:
        name: kubernetes
        state: present
      become: true
  roles:
    - role: metallb
      tags: ['metallb']
    - role: longhorn
      tags: ['longhorn']
    - role: certmanager
      tags: ['certmanager']
    - role: logging
      tags: ['logging']

- name: Deploy fluentbit on Pi Cluster Gateway
  hosts: gateway
  gather_facts: true
  tags: [logging]
  vars:
    ansible_become: true
  roles:
    - role: ricsanfre.fluentbit
      tags: ['logging']
