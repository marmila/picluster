---

- name: Configure Pi Cluster Gateway
  hosts: gateway
  gather_facts: true
  tags: [gateway]
  vars:
    ansible_become: true
  roles:

    # OS basic setup tasks
    - role: basic_setup
      tags: [os]

    # Security Hardening
    - role: ricsanfre.security
      tags: [security]

    # DNS/DHCP server configuration
    - role: ricsanfre.dnsmasq
      tags: [dnsmasq]

    # Firewall (nftables) configuration
    - role: ricsanfre.firewall
      tags: [firewall]

    # NTP Server configuration
    - role: ricsanfre.ntp
      tags: [ntp]

  tasks:
    # Aditional Tasks in case alternative architecture (centralized SAN)
    - name: Centralized SAN
      block:
        # Include centralized san variables
        - name: Include iSCSI variables
          include_vars:
            file: vars/centralized_san/iscsi_target.yml
        # iSCSI LUNs: LVM Volumes configuration
        - name: Configure iSCSI SAN Target
          include_role:
            name: ricsanfre.storage
        # iSCSI LUNs: LVM Volumes configuration
        - name: Configure iSCSI SAN Target
          include_role:
            name: ricsanfre.iscsi_target
      when: centralized_san
      tags: [iscsi]

- name: Configure Pi Cluster Nodes
  hosts: picluster
  gather_facts: true
  tags: [node]
  vars:
    ansible_become: true
  roles:

    # OS basic setup tasks
    - role: basic_setup
      tags: [os]

    # Security Hardening
    - role: ricsanfre.security
      tags: [security]

    # NTP Client configuration
    - role: ricsanfre.ntp
      tags: [ntp]

  tasks:
    # Aditional Tasks in case alternative architecture (centralized SAN)
    - name: Centralized SAN
      block:
        # Include centralized san variables
        - name: Include iSCSI variables
          include_vars:
            file: vars/centralized_san/iscsi_initiator.yml
        # iSCSI client (initiator) configuration
        - name: Configure iSCSI Initiator
          include_role:
            name: ricsanfre.iscsi_initiator
        # Mounting iSCSI LUNs
        - name: Configure iSCSI SAN Target
          include_role:
            name: ricsanfre.storage
      when: centralized_san
      tags: [iscsi]

      # Local Storage configuration
    - name: Dedicated Disks
      block:
        # Include centralized san variables
        - name: Include node storage variables
          include_vars:
            file: vars/dedicated_disks/local_storage.yml
        # iSCSI client (initiator) configuration
        # iSCSI initiator needs to be configured for Longhorn
        - name: Configure iSCSI Initiator
          include_role:
            name: ricsanfre.iscsi_initiator
          vars:
            - open_iscsi_automatic_startup: true
        # Configure local storage
        - name: Configure Local Storage
          include_role:
            name: ricsanfre.storage
      when: not centralized_san
      tags: [storage]

- name: Configure Backup Server - S3 Storage
  hosts: node1
  gather_facts: true
  tags: [backup]
  vars:
    ansible_become: true
    server_hostname: s3.picluster.ricsanfre.com
    ssl_key_size: 4096
    ssl_certificate_provider: selfsigned

  pre_tasks:
    - name: Generate self-signed SSL certificates for minio
      include_tasks: tasks/generate_selfsigned_cert.yml
      args:
        apply:
          delegate_to: localhost
          become: false
    - name: Load tls key and cert
      set_fact:
        minio_key: "{{ lookup('file','certificates/' + server_hostname + '_private.key') }}"
        minio_cert: "{{ lookup('file','certificates/' + server_hostname + '_public.crt') }}"

  tasks:
    - name: Include node storage variables
      include_vars:
        file: vars/backup/s3_minio.yml
    - name: Configure Minio S3 server
      include_role:
        name: ricsanfre.minio
