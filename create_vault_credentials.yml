---

- name: Generate vault variables file
  hosts: localhost

  vars_prompt:
    - name: k3s_token
      prompt: Enter K3S token
      private: true
    - name: ionos_public_prefix
      prompt: Enter IONOS public prefix
      private: true
    - name: ionos_secret
      prompt: Enter IONOS secret
      private: true
    - name: minio_root_password
      prompt: Enter Minio root user password
      private: true
    - name: minio_restic_password
      prompt: Enter Minio restic user password
      private: true
    - name: minio_longhorn_password
      prompt: Enter Minio longhorn user password
      private: true
    - name: minio_velero_password
      prompt: Enter Minio velero user password
      private: true
    - name: minio_loki_password
      prompt: Enter Minio loki user password
      private: true
    - name: minio_tempo_password
      prompt: Enter Minio tempo user password
      private: true
    - name: traefik_basic_auth_password
      prompt: Enter Traefik admin password
      private: true
    - name: elasticsearch_admin_password
      prompt: Enter Elasticsearch admin password
      private: true
    - name: fluentd_shared_key
      prompt: Enter Fluentd shared secret
      private: true
    - name: grafana_admin_password
      prompt: Enter Grafana admin password
      private: true
  pre_tasks:
    - name: "Ask for SAN centralized credentials"
      when: centralized_san
      block:
        - name: "Ask for SAN iscsi credentials 1/2"
          pause:
            prompt: "Enter iSCSI node password: "
            echo: false
          register: prompt
        - name: Set iSCSI node password variable
          set_fact:
            san_iscsi_node_pass: "{{ prompt.user_input }}"
          no_log: true
        - name: "Ask for SAN iscsi credentials 2/2"
          pause:
            prompt: "Enter iSCSI mutual password: "
            echo: false
          register: prompt
        - name: Set iSCSI node password variable
          set_fact:
            san_iscsi_mutual_pass: "{{ prompt.user_input }}"
          no_log: true

  tasks:
    - name: Generate vault file
      template:
        src: vars/vault.yml.j2
        dest: vars/vault-new.yml

    - name: Encryp file
      command:
        cmd: ansible-vault encrypt --vault-password-file=./.vault/vault-pass.sh vars/vault.yml
