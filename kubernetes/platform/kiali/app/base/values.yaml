# kiali-operator helm values (base)

cr:
  create: true
  namespace: istio-system
  spec:
    auth:
      # strategy: "anonymous"
      strategy: openid
      openid:
        client_id: "kiali"
        disable_rbac: true
        issuer_uri: "https://sso.${CLUSTER_DOMAIN}/realms/picluster"
    external_services:
      prometheus:
        # Prometheus service
        url: "http://kube-prometheus-stack-prometheus.kube-prom-stack.svc.cluster.local:9090/"  # [MODIFIED] Added full FQDN for reliable DNS resolution
        health_check_url: "http://kube-prometheus-stack-prometheus.kube-prom-stack.svc.cluster.local:9090/-/healthy"  # [ADDED] Health check endpoint
      grafana:
        enabled: true
        # Grafana service name is "grafana" and is in the "grafana" namespace.
        in_cluster_url: 'http://grafana.grafana.svc.cluster.local:3000/'  # [MODIFIED] Changed to standard Grafana port 3000
        # Public facing URL of Grafana
        url: 'https://monitoring.${CLUSTER_DOMAIN}/grafana/'
        auth:
          # Use same OAuth2.0 token used for accesing Kiali
          type: bearer
          use_kiali_token: true
        dashboards:  # [ADDED] Dashboard configuration
          - name: "Istio Service Dashboard"  # Default Istio dashboard
            title: "Istio Service Dashboard"
      tracing:
        # Enabled by default. Kiali will anyway fallback to disabled if
        # Tempo is unreachable.
        enabled: true
        # Tempo service name is "query-frontend" and is in the "tempo" namespace.
        in_cluster_url: "http://tempo-query-frontend.tempo.svc.cluster.local:3100/"
        provider: "tempo"
        tempo_config:
          org_id: "1"
          datasource_uid: "a8d2ef1c-d31c-4de5-a90b-e7bc5252cd00"
        # Use grpc to speed up the download of metrics
        use_grpc: true
        grpc_port: 9095
    deployment:
      ingress:
        class_name: "nginx"
        enabled: true
        override_yaml:
          metadata:
            annotations:
              # Enable cert-manager to create automatically the SSL certificate and store in Secret
              # Possible Cluster-Issuer values:
              #   * 'letsencrypt-issuer' (valid TLS certificate using IONOS API)
              #   * 'ca-issuer' (CA-signed certificate, not valid)
              cert-manager.io/cluster-issuer: letsencrypt-issuer
              cert-manager.io/common-name: kiali.${CLUSTER_DOMAIN}
              # [ADDED] Timeout settings to prevent UI disconnections
              nginx.ingress.kubernetes.io/proxy-read-timeout: "120"
              nginx.ingress.kubernetes.io/proxy-send-timeout: "120"
          spec:
            rules:
            - host: kiali.${CLUSTER_DOMAIN}
              http:
                paths:
                - backend:
                    service:
                      name: kiali
                      port:
                        number: 20001
                  path: /
                  pathType: Prefix
            tls:
            - hosts:
              - kiali.${CLUSTER_DOMAIN}
              secretName: kiali-tls
      # Enabling debug logs
      logger:
        log_level: debug