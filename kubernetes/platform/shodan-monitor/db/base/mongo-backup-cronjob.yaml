apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongo-backup
  namespace: shodan-monitor
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM (1 hour after PostgreSQL backup)
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400  # Keep job for 24 hours
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: mongo-backup
              image: mongo:8.2.4
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  BACKUP_DIR="/tmp/backup/mongodb"
                  BACKUP_FILE="${BACKUP_DIR}/mongodb-$(date +%Y%m%d-%H%M%S).gz"

                  echo "=========================================="
                  echo "Starting MongoDB backup at $(date)"
                  echo "=========================================="

                  # Create backup directory if it doesn't exist
                  mkdir -p "${BACKUP_DIR}"
                  echo "Backup directory: ${BACKUP_DIR}"

                  # Build MongoDB connection URI
                  MONGO_URI="mongodb://${MONGO_USER}:${MONGO_PASS}@${MONGO_HOST}:27017/?authSource=admin"
                  echo "Connecting to MongoDB at: ${MONGO_HOST}:27017"
                  echo "Backup target: ${BACKUP_FILE}"

                  # Test connection and list databases
                  echo "=========================================="
                  echo "Testing MongoDB connection..."
                  echo "=========================================="

                  # Try to connect and list all databases
                  if mongosh "${MONGO_URI}" --quiet --eval "db.adminCommand('listDatabases')" > /tmp/mongo_test.txt 2>&1; then
                    echo "✓ Connection successful"
                    echo "Available databases:"
                    mongosh "${MONGO_URI}" --quiet --eval "
                      db.adminCommand('listDatabases').databases.forEach(function(d) {
                        print('  - ' + d.name + ' (' + (d.sizeOnDisk / 1024 / 1024).toFixed(2) + ' MB)');
                      });
                    " 2>/dev/null || cat /tmp/mongo_test.txt

                    echo ""
                    echo "Checking target databases..."
                    for DB_NAME in shodan_intel apexforge_intelligence; do
                      echo "  Database: ${DB_NAME}"
                      COLLECTIONS=$(mongosh "${MONGO_URI}" --quiet --eval "
                        use ${DB_NAME};
                        db.getCollectionNames().forEach(function(c) {
                          var count = db[c].countDocuments();
                          var size = db[c].stats().size;
                          print('    Collection: ' + c + ', Documents: ' + count + ', Size: ' + (size / 1024).toFixed(2) + ' KB');
                        });
                      " 2>/dev/null)

                      if [ -z "$COLLECTIONS" ] || [ "$COLLECTIONS" = "" ]; then
                        echo "    ⚠ WARNING: No collections found or database does not exist!"
                      else
                        echo "$COLLECTIONS"
                      fi
                    done
                  else
                    echo "✗ Connection failed!"
                    echo "Error details:"
                    cat /tmp/mongo_test.txt
                    echo "=========================================="
                    exit 1
                  fi
                  echo "=========================================="

                  echo "Starting mongodump..."
                  START_TIME=$(date +%s)

                  # Perform backup with compression and archive format
                  # Using --gzip and --archive for efficient streaming backup
                  echo "Executing: mongodump --uri=*** --gzip --archive=${BACKUP_FILE} --numParallelCollections=4 --db=shodan_intel --db=apexforge_intelligence"

                  # Run mongodump and capture both stdout and stderr
                  # Use a temporary file to capture output since we're using a pipe
                  mongodump \
                    --uri="${MONGO_URI}" \
                    --gzip \
                    --archive="${BACKUP_FILE}" \
                    --numParallelCollections=4 \
                    --db=shodan_intel \
                    --db=apexforge_intelligence > /tmp/mongodump_output.log 2>&1

                  DUMP_EXIT_CODE=$?

                  # Display mongodump output
                  if [ -s /tmp/mongodump_output.log ]; then
                    echo "Mongodump output:"
                    while IFS= read -r line; do
                      echo "[mongodump] $(date '+%Y-%m-%d %H:%M:%S') $line"
                    done < /tmp/mongodump_output.log
                  else
                    echo "No output from mongodump (this may indicate empty databases)"
                  fi
                  END_TIME=$(date +%s)
                  DURATION=$((END_TIME - START_TIME))

                  if [ $DUMP_EXIT_CODE -eq 0 ]; then
                    echo "=========================================="
                    echo "Backup completed successfully!"
                    echo "Duration: ${DURATION} seconds"
                    echo "Backup file: ${BACKUP_FILE}"
                    ls -lh "${BACKUP_FILE}"
                    BACKUP_SIZE=$(stat -f%z "${BACKUP_FILE}" 2>/dev/null || stat -c%s "${BACKUP_FILE}" 2>/dev/null || echo "0")
                    echo "File size: $(du -h "${BACKUP_FILE}" | cut -f1) ($(numfmt --to=iec-i --suffix=B ${BACKUP_SIZE} 2>/dev/null || echo ${BACKUP_SIZE} bytes))"

                    # Warn if backup is suspiciously small
                    if [ ${BACKUP_SIZE} -lt 1000 ]; then
                      echo ""
                      echo "⚠ WARNING: Backup file is very small (${BACKUP_SIZE} bytes)!"
                      echo "This usually means:"
                      echo "  1. The databases are empty (no collections or documents)"
                      echo "  2. The databases don't exist"
                      echo "  3. There was an issue during backup"
                      echo ""
                      echo "Please verify the databases have data by checking MongoDB directly."
                    fi
                    echo "=========================================="
                  else
                    echo "=========================================="
                    echo "ERROR: Backup failed with exit code: $DUMP_EXIT_CODE"
                    if [ -s /tmp/mongodump_output.log ]; then
                      echo "Error details:"
                      cat /tmp/mongodump_output.log
                    fi
                    echo "=========================================="
                    exit $DUMP_EXIT_CODE
                  fi

                  # Cleanup old backups (keep last 7 days)
                  echo "Cleaning up backups older than 7 days..."
                  DELETED_COUNT=$(find "${BACKUP_DIR}" -name "mongodb-*.gz" -mtime +7 -delete -print | wc -l)
                  echo "Deleted ${DELETED_COUNT} old backup(s)"

                  # List remaining backups
                  echo "=========================================="
                  echo "Remaining backups:"
                  ls -lh "${BACKUP_DIR}/mongodb-"*.gz 2>/dev/null || echo "No backups found"
                  echo "=========================================="

                  echo "MongoDB backup job completed successfully at $(date)"
              volumeMounts:
                - name: backup-storage
                  mountPath: /tmp/backup
              env:
                - name: MONGO_HOST
                  value: shodan-mongo-svc.shodan-monitor.svc.cluster.local
                - name: MONGO_USER
                  valueFrom:
                    secretKeyRef:
                      name: shodan-mongo-credentials
                      key: MONGO_USER
                - name: MONGO_PASS
                  valueFrom:
                    secretKeyRef:
                      name: shodan-mongo-credentials
                      key: MONGO_PASS
              resources:
                requests:
                  memory: "512Mi"
                  cpu: "500m"
                limits:
                  memory: "2Gi"
                  cpu: "1000m"
          volumes:
            - name: backup-storage
              hostPath:
                path: /var/backups/apex-forge
                type: DirectoryOrCreate