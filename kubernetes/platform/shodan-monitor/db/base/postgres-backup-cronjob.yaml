apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: shodan-monitor
spec:
  schedule: "0 1 * * *"  # Daily at 1 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400  # Keep job for 24 hours
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: postgres-backup
              image: postgres:15
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  BACKUP_DIR="/tmp/backup/postgres"
                  BACKUP_FILE="${BACKUP_DIR}/postgres-$(date +%Y%m%d-%H%M%S).dump"
                  
                  echo "Starting PostgreSQL backup..."
                  
                  # Create backup directory if it doesn't exist
                  mkdir -p "${BACKUP_DIR}"
                  
                  # Perform backup with custom format (compressed)
                  PGPASSWORD="${DB_PASS}" pg_dump \
                    -h "${DB_HOST}" \
                    -U "${DB_USER}" \
                    -d "${DB_NAME}" \
                    -Fc \
                    -f "${BACKUP_FILE}"
                  
                  # Compress the dump file
                  gzip "${BACKUP_FILE}"
                  
                  echo "Backup completed: ${BACKUP_FILE}.gz"
                  ls -lh "${BACKUP_DIR}/postgres-"*.dump.gz | tail -1
                  
                  # Cleanup old backups (keep last 7 days)
                  echo "Cleaning up backups older than 7 days..."
                  find "${BACKUP_DIR}" -name "postgres-*.dump.gz" -mtime +7 -delete
                  
                  # List remaining backups
                  echo "Remaining backups:"
                  ls -lh "${BACKUP_DIR}/postgres-"*.dump.gz 2>/dev/null || echo "No backups found"
                  
                  echo "PostgreSQL backup job completed successfully"
              volumeMounts:
                - name: backup-storage
                  mountPath: /tmp/backup
              env:
                - name: DB_HOST
                  value: shodan-postgres.shodan-monitor.svc.cluster.local
                - name: DB_NAME
                  value: shodan
                - name: DB_USER
                  valueFrom:
                    secretKeyRef:
                      name: shodan-db-credentials
                      key: DB_USER
                - name: DB_PASS
                  valueFrom:
                    secretKeyRef:
                      name: shodan-db-credentials
                      key: DB_PASS
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "200m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
          volumes:
            - name: backup-storage
              hostPath:
                path: /var/backups/apex-forge
                type: DirectoryOrCreate
