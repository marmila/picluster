---
# fluentbit helm chart values

#fluentbit-container environment variables
env:
  # Fluentd deployment service
  - name: FLUENT_AGGREGATOR_HOST
    value: "fluentd"
  # Default fluentd forward port
  - name: FLUENT_AGGREGATOR_PORT
    value: "24224"
  - name: FLUENT_AGGREGATOR_SHARED_KEY
    valueFrom:
      secretKeyRef:
        name: fluentd-shared-key
        key: fluentd-shared-key
  - name: FLUENT_SELFHOSTNAME
    valueFrom:
      fieldRef:
        fieldPath: spec.nodeName
  # Specify TZ
  - name: TZ
    value: "{{ efk_node_timezone }}"
# Fluentbit config
config:
  # Helm chart combines service, inputs, outputs, custom_parsers and filters section
  # fluent-bit.config SERVICE
  service: |

    [SERVICE]
        Daemon Off
        Flush 1
        Log_Level info
        Parsers_File parsers.conf
        Parsers_File custom_parsers.conf
        HTTP_Server On
        HTTP_Listen 0.0.0.0
        HTTP_Port 2020
        Health_Check On

  # fluent-bit.config INPUT
  inputs: |

    [INPUT]
        Name tail
        Path /var/log/containers/*.log
        multiline.parser cri
        DB /var/log/fluentbit/flb_kube.db
        Tag kube.*
        Mem_Buf_Limit 5MB
        Skip_Long_Lines True

    [INPUT]
        Name tail
        Tag host.*
        DB /var/log/fluentbit/flb_host.db
        Path /var/log/auth.log,/var/log/syslog
        Parser syslog-rfc3164-nopri

  # fluent-bit.config OUTPUT
  outputs: |

    [OUTPUT]
        Name forward
        match *
        Host ${FLUENT_AGGREGATOR_HOST}
        Port ${FLUENT_AGGREGATOR_PORT}
        Self_Hostname ${FLUENT_SELFHOSTNAME}
        Shared_Key ${FLUENT_AGGREGATOR_SHARED_KEY}
        tls True
        tls.verify False

  # fluent-bit.config PARSERS
  customParsers: |

    [PARSER]
        Name syslog-rfc3164-nopri
        Format regex
        Regex /^(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$/
        Time_Key time
        Time_Format %b %d %H:%M:%S
        Time_Keep False

  # fluent-bit.config FILTERS
  filters: |

    [FILTER]
        Name kubernetes
        Match kube.*
        Kube_Tag_Prefix kube.var.log.containers.
        Merge_Log True
        Merge_Log_Trim True
        Keep_Log False
        K8S-Logging.Parser True
        K8S-Logging.Exclude False
        Annotations False
        Labels False

    [FILTER]
        Name nest
        Match kube.*
        Operation lift
        Nested_under kubernetes
        Add_prefix kubernetes_

    [FILTER]
        Name modify
        Match kube.*
        Rename kubernetes_pod_name k8s.pod.name
        Rename kubernetes_namespace_name k8s.namespace.name
        Rename kubernetes_container_name k8s.container.name
        Remove kubernetes_container_image
        Remove kubernetes_docker_id
        Remove kubernetes_pod_id
        Remove kubernetes_host
        Remove kubernetes_container_hash
        Remove stream
        Remove _p
        Rename log message
        Add k8s.cluster.name picluster

    [FILTER]
        Name lua
        Match host.*
        script /fluent-bit/scripts/adjust_ts.lua
        call local_timestamp_to_UTC

# Fluentbit config Lua Scripts
luaScripts:
{% for lua_script in fluentbit_lua_script %}
  {{ lua_script.name }}: |
{{ lua_script.content | indent(4, True)}}
{% endfor %}

# Enable fluentbit instalaltion on master node
tolerations:
  - key: node-role.kubernetes.io/master
    operator: Exists
    effect: NoSchedule

# Log_Level
logLevel: {{ fluent_bit_log_level }}

# Init container
initContainers:
  - name: init-log-directory
    image: busybox
    command: ['/bin/sh', '-c', 'if [ ! -d /var/log/fluentbit ]; then mkdir -p /var/log/fluentbit; fi']
    volumeMounts:
      - name: varlog
        mountPath: /var/log
